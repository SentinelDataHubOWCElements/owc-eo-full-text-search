<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../owc-ui-list/owc-ui-list.html">

<dom-module id="owc-eo-full-text-search">
  <template>
    <style is="custom-style">
      :host {
        display: block;
      }

      #searchboxinput {
        display: block;
        min-height: 40px;
        width: 98%;
        margin-bottom: 5px;
        align-self: center;
        font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 14px;
        resize: vertical;
        overflow-y: auto;
      }

      paper-icon-button {
        color: #002664;
        font-weight: bold;
      }

      paper-icon-button[toggles][active][raised].colorful {
        color: rgba(66, 133, 244, 0.75);
      }
    </style>
    <div id="search-container"></div>
    <paper-input label="Insert search criteria..." id="searchboxinput">
      <paper-icon-button style="width: 33px;" slot="suffix" on-click="clear" icon="clear" alt="clear" title="clear"></paper-icon-button>
      <paper-icon-button style="width: 33px;" slot="suffix" on-click="search" icon="search" alt="search" title="search"></paper-icon-button>
    </paper-input>
    </div>
  </template>
  <script>
    class OwcEoFullTextSearch extends Polymer.Element {
      static get is() {
        return 'owc-eo-full-text-search';
      }
      static get properties() {
        return {
          baseUrl: {
            type: String,
            value: 'default baseurl'
          },
          apiUrl: {
            type: String,
            value: 'default apiUrl'
          },
          model: {
            type: Array,
            value: []
          },
        };
      }

      //Configuration
      ready() {
        super.ready();
        var self = this;
        self.baseUrl = 'https://scihub.copernicus.eu/dhus';
        self.apiUrl = '/api/stub/products?filter=';
      }

      search() {
        var self = this;
        //If user is not logged push the login component
        if (this._ctx.am.logged == false) this._ctx.wm.pushComponent(document.createElement('owc-ui-login-box'), "150px", "Login Title");

        else {//User Logged
          var query = this.$.searchboxinput.value;
          if (query == "") query = "*"; //Perform full search if field is empty
          var options = '&offset=0&limit=25&sortedby=ingestiondate&order=desc'
          
          var requestUrl = self.baseUrl + self.apiUrl + query + options;
          this._ctx.hm.sendRequest("GET", requestUrl).then(
            function (result) { //OK: Inject useful information into model for each product
              result.data.products.forEach(function (element, index) {
                self.model[index] = new itemModel(element.identifier, element.thumbnail, element.uuid, self.baseUrl, element.summary);
              });

              var owcUiList = document.createElement('owc-ui-list');
              owcUiList.model = self.model; //model injection
              self._ctx.wm.pushComponent(owcUiList, "150px", "List Title");
              return result;
            },
            function (err) { return err; }
          );
        }
      }

      clear() {
        this.$.searchboxinput.value = "";
      }
    }

    //Model used by owc-ui-row-item.html
    class itemModel {
      constructor(title, thumb, thumbUrl, url, attributes) {
        this.title = title;
        this.thumb = thumb;
        this.thumbUrl = thumbUrl;
        this.url = url; //used for baseUrl
        this.attributes = attributes;
      }
    }

    window.customElements.define(OwcEoFullTextSearch.is, OwcEoFullTextSearch);
  </script>
</dom-module>