<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/all-imports.html">

<dom-module id="owc-eo-full-text-search">
  <template>
    <style>
      #noProducts {
				font-weight: bold;
				color: #c0392b;
			}

      paper-icon-button {
        color: #273c75 /*002664*/
      }
    </style>

    <paper-input id="searchboxinput" label="Insert search criteria" on-keydown="onKeyDown">
      <paper-icon-button style="width: 35px;" slot="suffix" on-click="clear" icon="clear" alt="clear" title="clear"></paper-icon-button>
      <paper-icon-button style="width: 35px;" slot="suffix" on-click="search" icon="search" alt="search" title="search"></paper-icon-button>
    </paper-input>
    <div id="noProducts" hidden$="{{!isEmptySearch}}">No products found</div>
  </template>
  <!-- import extrnal js class file -->
  <script type="text/javascript" src="itemModel.js"></script>
  <script>
    class OwcEoFullTextSearch extends Polymer.Element {
      static get is() {
        return 'owc-eo-full-text-search';
      }
      static get properties() {
        return {
          baseUrl: {
            type: String,
            value: 'default apiUrl'
          },
          apiUrl: {
            type: String,
            value: 'default apiUrl'
          },
          model: {
            type: Array,
            value: []
          },
          isEmptySearch: {
            type: Boolean,
            value: false
          },
        };
      }

      //Component Configuration
      ready() {
        super.ready();
        var self = this;
        self.apiUrl = '/api/stub/products?filter=';

        //CONTEXT ASSIGNMENT
        self._ctx = ApplicationContext.getInstance().context;
        self.baseUrl = self._ctx.bu; //Get baseUrl information from starter kit component
      }

      search() {
        var self = this;

        //If user is not logged push the login component end return
        if (self._ctx.am.logged == false) {
          self._ctx.wm.pushComponent(document.createElement('owc-ui-login-box'), "150px", "Login Title");
          return;
        }

        //User Logged
        var query = self.$.searchboxinput.value;
        if (query == "") query = "*" //Perform full search if field is empty
        var options = '&offset=0&limit=25&sortedby=ingestiondate&order=desc'

        //Create request
        var requestUrl = self.baseUrl + self.apiUrl + query + options;

        //Perform request
        self._ctx.hm.sendRequest("GET", requestUrl).then(
          function (result) { //OK: 
            self.model = [] //Clear current model

            if (result.data.products.length <= 0) //No Products founded
              self.isEmptySearch = true;

            else
              result.data.products.forEach(function (e, index) {//Inject useful info in current model
                self.model[index] = new ItemModel(e.identifier, e.thumbnail, e.uuid, self.baseUrl, e.summary);
              })

            self._ctx.resource = self.model; //Set Datasource model 
            self._ctx.mb.publish("search"); //Publish search completed on message broker to update the list
            return result;
          },
          function (err) { return err; }
        );
      }

      clear() {
        var self = this;
        self.$.searchboxinput.value = "";
      }

      onKeyDown(keyDown) {
        var self = this;
        switch (keyDown.keyCode) {
          case 13:
            self.search();
            break;
          default:
            self.isEmptySearch = false
            break;
        }
      }
    }

    window.customElements.define(OwcEoFullTextSearch.is, OwcEoFullTextSearch);
  </script>
</dom-module>